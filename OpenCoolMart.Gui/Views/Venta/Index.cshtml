@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}

<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="~/css/Venta/Venta.css" rel="stylesheet" />

</head>
<body>
    <div id="content">
        <img src="~/Img/Imagen3.png" class="ribbon">
    </div>

    <div class="table-responsive">
        <div class="table-wrapper">
            <div class="table-title">
                <div class="col-sm-8"><h2>Productos</h2></div>
                <div class="search-box">
                    <i class="material-icons">&#xE8B6;</i>
                    <input type="text" class="form-control" placeholder="Codigo del Producto" id="codigoprod">
                </div>
            </div>
            <br />
            <div class="form-group row">
                <div id="tabla">
                    <table id="tablaventa" class="table table-striped table-hover table-bordered" style="min-width:725px; max-width: 825px;">
                        <thead style="background-color:lightgray">
                            <tr>
                                <th style="width:80px;">Prod.#</th>
                                <th style="width:125px;">Codigo</th>
                                <th style="width:220px;">Descripción</th>
                                <th style="width:100px;">Cantidad</th>
                                <th style="width:100px;">Precio U.</th>
                                <th style="width:110px;">SubTotal</th>
                                <th style="width:110px">Opciones</th>
                            </tr>
                        </thead>
                        <tbody>                      



                        </tbody>
                    </table>
                </div>
                <div >
                    <a asp-controller="Home" asp-action="Menu" class="btn btn-primary boton">Menu</a>
                    <br />
                    <a asp-controller="Venta" asp-action="GetVentas" class="btn btn-success boton">Buscar Venta</a>
                    <br />
                    <a class="btn btn-success boton">Buscar Producto</a>
                    <br />
                    <button class="btn btn-danger boton">Cancelaar Venta</button>
                </div>
                
            </div>
            
            <div class="form-group row">
                <div class="col-md-7">
                    <p>Subtotal: <input id="SubTotal" disabled/> </p>
                    <p>Iva: <label id="Iva">16</label>%</p>
                    <p>Total: <input id="TotalCompra" disabled /></p>
                </div>
                <div>
                    <button class="btn btn-success boton" style="margin-left:100px; margin-top:50px;">Pagar</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

@section Scripts{ 
    <script>
        var productos = [];
        var tecla_enter;
        var TotalCompra;
        var SubTotalCompra = 0;
        var valorresta = 0;
        var SubTotal = 0;
        function press_Enter() {
            tecla_enter = event.keyCode;
            if (tecla_enter == 13) {

                var codigo = $("#codigoprod").val();
                var producto="Hola";
                $.ajax({
                    url: "https://localhost:44315/api/Producto/Prod/"+codigo,
                    method: "GET"
                }).done(function (data) {
                    if (data == null)
                        alert("Este producto no existe")
                    else if (parseInt(data.stock) <= 0)
                        alert("cantidad del producto insufuciente para vender")
                    else {
                        /*if (productos.indexOf(data.id) >= 0) {
                            alert("El numero repetido es: " + productos.indexOf(data.id))
                            Sumar_Productos(data);
                        }
                        else {

                        }*/
                        productos.push(data.id);
                        agregarfila(data);
                    }

                }).fail(function (jqXHR, textStatus, error) {
                    alert("lo sentimos ha habido un error");
                });
            }
        }
        document.addEventListener('keydown', press_Enter);

        function agregarfila(data) {
            var cantidad = 1
            SubTotal = parseInt(data.precio) * cantidad;
            var cadena;
            cadena = "<tr>"
            cadena = cadena + "<td>" + data.id + "</td>";
            cadena = cadena + "<td>" + data.codigoProducto + "</td>";
            cadena = cadena + "<td>" + data.descripcion + "</td>";
            cadena = cadena + "<td>" + cantidad + "</td>";
            cadena = cadena + "<td>" + data.precio + "</td>";
            cadena = cadena + "<td>" + SubTotal + "</td>";
            cadena = cadena + "<td style='width: 150px;'> <a class='aumenta' > <button class='btn' style='width:40px; heigh=40px'; onclick='aumentarCantidad()'><i class='material-icons'>&#xE254;</i></button></a > <a class ='elimina'><button class='btn btn-danger' type='button'><span class='fa fa-remove'></span></button></a></td>";

            sumar()
            $("#tablaventa").append(cadena);
            fn_dar_eliminar();
        }

        function sumar() {
            SubTotalCompra = SubTotalCompra + SubTotal;
            TotalCompra = SubTotalCompra * 1.16;
            $("#SubTotal").val(SubTotalCompra);
            $("#TotalCompra").val(TotalCompra);
        }

        function restar() {
            SubTotalCompra = SubTotalCompra - valorresta;
            TotalCompra = SubTotalCompra * 1.16;
            $("#SubTotal").val(SubTotalCompra);
            $("#TotalCompra").val(TotalCompra);
        }

        function fn_dar_eliminar() {
            $("a.elimina").click(function () {
                valorresta = $(this).parents("tr").find("td").eq(5).html();
                 
                $(this).parents("tr").fadeOut("normal", function () {
                    $(this).remove();
                    restar();
                });
            });
        };
        
        function aumentarCantidad() {            
            cantidad = parseInt(prompt("Escoge la cantidad de productos", 1));
            $("a.aumenta").click(function () {
                var Indice = $(this).parents("tr").index();
                var CantidadAc = $(this).parents("tr").find("td").eq(3).html();
                var precioUni = $(this).parents("tr").find("td").eq(4).html();
                
                if (cantidad >= 1 && Indice >= 0) {
                    var diferencia=cantidad - CantidadAc;
                    document.getElementById("tablaventa").rows[Indice + 1].cells[3].innerHTML = cantidad;
                    document.getElementById("tablaventa").rows[Indice + 1].cells[5].innerHTML = cantidad * precioUni;
                    
                    if (diferencia > 0) {
                        SubTotal = diferencia * precioUni;
                        sumar();
                    }
                    else if (diferencia < 0) {
                        valorresta = diferencia * precioUni * -1;
                        restar();
                    }
                };
            });
            
        };

        function Sumar_Productos(data) {
            document.getElementById("tablaventa").rows[1].cells[1].innerHTML = 10;
            var valor2 = document.getElementById("tablaventa").rows[1].cells[1].innerHTML;
            alert(valor2)
        }
    </script>
}